<% var key = new Date().toLocaleString();
    key = key.replace(/\:/g,"");
    key = key.replace(/\//g,"");
    key = key.replace(/\ /g,"");
    key = key.replace(/\-/g,"");
var total = 0;

var gasPrice = new Intl.NumberFormat('es-CL',
        { style: 'currency', currency: 'CLP',
            minimumFractionDigits: 0 });
%>
<div class="container" id="key">
    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <input type="hidden" id="thiscdc" value="<%= cdc.idcdc%>">
                    <h1><%= cdc.nombre%> <a class="btn btn-warning"><i class="fa fa-wrench"></i>Modificar</a></h1>
                </div>
                <div class="panel-body" style="display: flex">
                    <div class="panelitem"><p><strong>Fecha de inicio:</strong></p><p style="margin-top: 5px"><%= new Date(cdc.f_inicio).toLocaleDateString()%></p></div>
                    <div class="panelitem"><p><strong>Fecha de finalización:</strong></p><p style="margin-top: 5px"><%= new Date(cdc.f_fin).toLocaleDateString()%></p></div>
                    <%var monto_total = cdc.i_total - cdc.e_total;%>
                    <div class="panelitem"><p><strong>Monto Contrato:</strong></p><p style="margin-top: 5px"><%= gasPrice.format(cdc.monto_final)%></p></div>
                    <div class="panelitem"><p><strong>Monto Final:</strong></p><p style="margin-top: 5px"><%= gasPrice.format(monto_total)%></p></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-5 col-md-offset-1">
            <div class="panel panel-success">
                <div class="panel-heading">
                    <h1>Ingresos <a class="btn btn-success pull-right pay" data-toggle="collapse" href="#newmov"> + Añadir</a></h1>
                </div>
                <div class="panel-body collapse" id="newmov">
                    <form class="payform">
                        <h3>Nuevo:</h3>
                        <div class="form-group">
                            <input placeholder="Descripción" type="text" name="detalle" class="form-control" required>
                        </div>
                        <div class="form-inline">
                            <label>Fecha de pago</label>
                            <input type="date" name="fecha" min="<%= new Date().toLocaleDateString()%>" class="form-control" required>
                            <input placeholder="Monto" type="number" name="monto" class="form-control" required>
                        </div>
                        <button class="btn btn-primary sending pull-right" data-tipo="2" style="margin:10px">Agregar</button>
                        <input type="hidden" class="hidden" name="idcdc" value="<%= cdc.idcdc%>">
                        <input type="hidden" class="hidden" name="tipo" value="ingreso">

                    </form>
                </div>
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <td>Detalle</td>
                        <td>N° Factura</td>
                        <td>Fecha</td>
                        <td>Monto</td>
                        <td></td>
                    </tr>
                    </thead>
                    <tbody>
                    <% if(ingreso.length){

                    for(var i = 0;i<ingreso.length;i++){
                        total += ingreso[i].monto;
                    %>
                    <tr>
                        <td><%= ingreso[i].detalle%></td>
                        <td><%= ingreso[i].n_factura%></td>
                        <td><%= new Date(ingreso[i].fecha).toLocaleDateString()%></td>
                        <td><%= gasPrice.format(ingreso[i].monto)%></td>
                        <td><a class="btn btn-info vercdc" data-idingreso="<%= ingreso[i].idingreso%>"><i class="fa fa-eye"></i>Ver</a></td>
                    </tr>
                    <% }
                    } else {%>
                    <tr>
                        <td>No hay facturas</td>
                    </tr>
                    <%}%>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-5">
            <div class="panel panel-danger">
                <div class="panel-heading">
                    <h1>Egresos <a class="btn btn-success pull-right pay" data-toggle="collapse" href="#newmov2" data-is_e="1"> + Añadir</a></h1>
                </div>
                <div class="panel-body collapse" id="newmov2">
                    <form class="payform">
                            <h3>Nuevo:</h3>
                        <div class="form-group">
                            <input placeholder="Descripción" maxlength="100" type="text" name="detalle" class="form-control" required>
                        </div>
                        <div class="form-inline">
                            <label>Fecha de pago</label>
                            <input type="date" name="fecha" id="fecha" min="<%= new Date().toLocaleDateString()%>" class="form-control" required>
                            <input placeholder="Monto" type="number" name="monto" maxlength="2" class="form-control" required>
                        </div>

                        <button class="btn btn-primary sending pull-right" data-tipo="2" style="margin:10px">Agregar</button>
                        <input type="hidden" class="hidden" name="idcdc" value="<%= cdc.idcdc%>">
                        <input type="hidden" class="hidden" name="tipo" value="egreso">

                    </form>
                </div>
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <td>Detalle</td>
                        <td>N° Factura</td>
                        <td>Fecha</td>
                        <td>Monto</td>
                        <td></td>
                    </tr>
                    </thead>
                    <tbody>
                    <% if(egreso.length){
                    for(var i = 0;i<egreso.length;i++){
                    %>
                    <tr>
                        <td><%= egreso[i].detalle%></td>
                        <td><%= egreso[i].n_factura%></td>
                        <td><%= new Date(egreso[i].fecha).toLocaleDateString()%></td>
                        <td><%= gasPrice.format(egreso[i].monto)%></td>
                        <td><a class="btn btn-info vercdc" data-idingreso="<%= egreso[i].idegreso%>"><i class="fa fa-eye"></i>Ver</a></td>
                    </tr>
                    <% }
                    } else {%>
                    <tr>
                        <td>No hay facturas</td>
                    </tr>
                    <%}%>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var esegreso
    $("#<%= key%> .pay").click(function(e){
        esegreso = $(this).data('is_e');
        if(parseInt(esegreso))
            $("#new_mov .modal-title").html("Registrar Egreso");
        else
            $("#new_mov .modal-title").html("Registrar Ingreso");

        $("#sendpay").val($(this).data('is_e'));
    });
    $("form.payform").submit(function(e){
        e.preventDefault();
        var formArray = $(this).serializeArray();
        var returnArray = {};
        for (var i = 0; i < formArray.length; i++){
            returnArray[formArray[i]['name']] = formArray[i]['value'];
        }
        $.ajax({
            url: "/cdc/save_pay",
            type: 'POST',
            data: returnArray,
            success: function(data){
                $("#page-container").html(data);
            }
        })
    });

</script>
<style type="text/css">
    .panelitem{
        width:33%;
        text-align: center;
    }
</style>